# Relax constraints for special workloads

[We shared](8.SetupRestrictedConstraints.md) how to apply a [set of ACM Policy Constraints](./policies/restricted/restricted_constraints.yaml) to enforce policies similar to the ones enforced by OpenShift `Restricted` [SCC](https://docs.openshift.com/container-platform/4.7/authentication/managing-security-context-constraints.html).

If you want to allow some workloads to not be constrained by all of the above policies you have 2 options:

1. Add the namespace(s) where the workloads would be deployed to the list of exempt namespaces as explained in [Installation Guide](https://cloud.google.com/anthos-config-management/docs/how-to/installing-policy-controller). In this case no constraint will be applied to any app deployed in one of the exempted namespaces.

2. If you want more granular control over constraints enforcement, you can define a list of namespaces to which a specific constraint is not applied using the `excludedNamespaces` selector.

For example if you change the `psp-pods-allowed-user-ranges` constraint in the [restricted_constraint.yaml](./policies/restricted/restricted_constraints.yaml) file as follows:

```
---
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPAllowedUsers
metadata:
  name: psp-pods-allowed-user-ranges
spec:
  match:  
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces:
    - allow-anyuid
  parameters:
    runAsUser:
      rule: MustRunAs # MustRunAsNonRoot # RunAsAny 
      ranges:
        - min: 1000
          max: 2000
    fsGroup:
      rule: MustRunAs # MayRunAs # RunAsAny 
      ranges:
        - min: 1000
          max: 2000
---
```
Pods created in the `allow-anyuid` namespace can run with any UID and any GID.

After you changed the manifest file as described above and commited the changes to the git repo you can test this new setting as follows:

* Try to create a pod where no specific UID or GID have been defined from the [example-allowed-anyuid.yaml](./policies/restricted/example-allowed-anyuid.yaml) manifest:
```
kubectl create ns test-policy
kubectl create -n test-policy -f policies/restricted/example-allowed-anyuid.yaml
```
And notice the rejection
```
Error from server ([denied by psp-pods-allowed-user-ranges] Container sec-ctx-demo is attempting to run without a required securityContext/runAsUser. Allowed runAsUser: {"ranges": [{"max": 2000, "min": 1000}], "rule": "MustRunAs"}
[denied by psp-pods-allowed-user-ranges] Container sec-ctx-demo is attempting to run without a required securityContext/fsGroup. Allowed fsGroup: {"ranges": [{"max": 2000, "min": 1000}], "rule": "MustRunAs"}): error when creating "example-allowed-anyuid.yaml": admission webhook "validation.gatekeeper.sh" denied the request: [denied by psp-pods-allowed-user-ranges] Container sec-ctx-demo is attempting to run without a required securityContext/runAsUser. Allowed runAsUser: {"ranges": [{"max": 2000, "min": 1000}], "rule": "MustRunAs"}
[denied by psp-pods-allowed-user-ranges] Container sec-ctx-demo is attempting to run without a required securityContext/fsGroup. Allowed fsGroup: {"ranges": [{"max": 2000, "min": 1000}], "rule": "MustRunAs"}
```

* Create the `allow-anyuid` namespace
```
kubectl create ns allow-anyuid
```
* Try the same operation in the `allow-anyuid` namespace that is exempted from the `psp-pods-allowed-user-ranges` constraint
```
kubectl create -n allow-anyuid -f policies/restricted/example-allowed-anyuid.yaml
```
and notice it gets deployed successfully

```
pod/anyuid-compliant-pod created
```

* Cleanup

```
kubectl delete pod/restricted-pod-example -n allow-anyuid
kubectl delete ns test-policy
kubectl delete ns allow-anyuid
```